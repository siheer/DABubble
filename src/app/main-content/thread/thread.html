<section class="thread lg:rounded-3xl xl:ml-4" *ngIf="thread$ | async as thread; else idleThread">
  <header class="thread__header">
    <div>
      <p class="thread__eyebrow">Thread</p>
      <h2 class="thread__title"># {{ thread.channelTitle }}</h2>
    </div>
    <div class="thread__header-actions">
      <span class="thread__badge">{{ thread.replies.length }} Antworten</span>
      <button type="button" class="thread__close hidden lg:flex" aria-label="Thread schließen" (click)="closeThread()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </header>
  <div class="thread__scroll-area" #threadScrollArea>
    <article class="thread__root" [class.thread__root--own]="thread.root.isOwn">
      <img class="thread__avatar" [src]="thread.root.avatarUrl" [alt]="thread.root.authorName" />
      <div class="thread__body">
        <div
          class="thread__bubble-actions"
          [class.thread__bubble-actions--visible]="openEmojiPickerFor === thread.root.id"
          [class.thread__bubble-actions--own]="thread.root.isOwn"
          aria-label="Aktionen für die Ausgangsnachricht">
          <button
            type="button"
            class="thread__bubble-action"
            aria-label="Emoji-Auswahl öffnen"
            (click)="toggleEmojiPicker(thread.root.id)">
            <mat-icon>add_reaction</mat-icon>
          </button>
          <button
            *ngIf="thread.root.isOwn"
            type="button"
            class="thread__bubble-action"
            aria-label="Weitere Aktionen"
            (click)="startEditingRoot(thread.root)">
            <mat-icon>more_vert</mat-icon>
          </button>

          <div
            class="thread__emoji-picker"
            [class.thread__emoji-picker--own]="thread.root.isOwn"
            *ngIf="openEmojiPickerFor === thread.root.id">
            <button
              type="button"
              *ngFor="let emoji of emojiChoices"
              (click)="reactToRootMessage(emoji)"
              aria-label="Emoji auswählen">
              {{ emoji }}
            </button>
          </div>
        </div>
        <div class="thread__meta">
          <strong>{{ thread.root.authorName }}</strong>
          <time>{{ thread.root.timestamp }}</time>
        </div>
        <ng-container *ngIf="editingMessageId !== thread.root.id; else editRootMessage">
          <p class="thread__text">
            <ng-container *ngFor="let segment of buildMessageSegments(thread.root.text)">
              <ng-container *ngIf="segment.member; else plainRootText">
                <button type="button" class="thread__mention-link" (click)="openMemberProfile(segment.member)">
                  {{ segment.text }}
                </button>
              </ng-container>
              <ng-template #plainRootText>{{ segment.text }}</ng-template>
            </ng-container>
          </p>
        </ng-container>
        <ng-template #editRootMessage>
          <div class="thread__edit">
            <textarea rows="3" [(ngModel)]="editMessageText" aria-label="Nachricht bearbeiten"></textarea>
            <div class="thread__edit-actions">
              <button type="button" class="thread__edit-cancel" (click)="cancelEditing()">Abbrechen</button>
              <button
                type="button"
                class="thread__edit-save"
                [disabled]="!editMessageText.trim() || isSavingEdit"
                (click)="saveEditing(thread.root, true)">
                Speichern
              </button>
            </div>
          </div>
        </ng-template>
      </div>
    </article>

    <div class="thread__divider">
      <span>{{ thread.replies.length }} Antworten</span>
    </div>

    <div class="thread__replies">
      <article *ngFor="let reply of thread.replies" class="thread__reply" [class.thread__reply--own]="reply.isOwn">
        <img class="thread__avatar" [src]="reply.avatarUrl" [alt]="reply.authorName" />
        <div class="thread__body">
          <div
            class="thread__bubble-actions"
            [class.thread__bubble-actions--visible]="openEmojiPickerFor === reply.id"
            [class.thread__bubble-actions--own]="reply.isOwn"
            aria-label="Aktionen für die Antwort">
            <button
              type="button"
              class="thread__bubble-action"
              aria-label="Emoji-Auswahl öffnen"
              (click)="toggleEmojiPicker(reply.id)">
              <mat-icon>add_reaction</mat-icon>
            </button>
            <button
              *ngIf="reply.isOwn"
              type="button"
              class="thread__bubble-action"
              aria-label="Weitere Aktionen"
              (click)="startEditing(reply)">
              <mat-icon>more_vert</mat-icon>
            </button>

            <div
              class="thread__emoji-picker"
              [class.thread__emoji-picker--own]="reply.isOwn"
              *ngIf="openEmojiPickerFor === reply.id">
              <button
                type="button"
                *ngFor="let emoji of emojiChoices"
                (click)="reactToReply(reply.id, emoji)"
                aria-label="Emoji auswählen">
                {{ emoji }}
              </button>
            </div>
          </div>
          <div class="thread__meta">
            <strong>{{ reply.authorName }}</strong>
            <time>{{ reply.timestamp }}</time>
          </div>
          <ng-container *ngIf="editingMessageId !== reply.id; else editReplyMessage">
            <p class="thread__text">
              <ng-container *ngFor="let segment of buildMessageSegments(reply.text)">
                <ng-container *ngIf="segment.member; else plainReplyText">
                  <button type="button" class="thread__mention-link" (click)="openMemberProfile(segment.member)">
                    {{ segment.text }}
                  </button>
                </ng-container>
                <ng-template #plainReplyText>{{ segment.text }}</ng-template>
              </ng-container>
            </p>
          </ng-container>
          <ng-template #editReplyMessage>
            <div class="thread__edit">
              <textarea rows="3" [(ngModel)]="editMessageText" aria-label="Nachricht bearbeiten"></textarea>
              <div class="thread__edit-actions">
                <button type="button" class="thread__edit-cancel" (click)="cancelEditing()">Abbrechen</button>
                <button
                  type="button"
                  class="thread__edit-save"
                  [disabled]="!editMessageText.trim() || isSavingEdit"
                  (click)="saveEditing(reply)">
                  Speichern
                </button>
              </div>
            </div>
          </ng-template>
          <app-message-reactions
            *ngIf="reply.reactions"
            [reactions]="reply.reactions"
            [currentUserId]="currentUser.uid"
            (react)="reactToReply(reply.id, $event)"
            (showTooltip)="showReactionTooltip($event.event, $event.emoji, $event.userIds)"
            (hideTooltip)="hideReactionTooltip()"></app-message-reactions>
        </div>
      </article>
    </div>
  </div>

  <form class="thread__composer" (ngSubmit)="sendReply()" #replyForm="ngForm">
    <img class="thread__avatar" [src]="currentUser.avatar" [alt]="currentUser.name" />
    <div class="thread__composer-input">
      <textarea
        name="reply"
        required
        [(ngModel)]="draftReply"
        #replyTextarea
        placeholder="Antworten"
        aria-label="Antwort zum Thread schreiben"
        (input)="onReplyInput($event)"
        (click)="onReplyInput($event)"
        (keydown.enter)="onReplyKeydown($event)"></textarea>
      <div *ngIf="isMentionListVisible" class="thread__mention-suggestions">
        <button type="button" *ngFor="let member of mentionSuggestions" (click)="insertMention(member)">
          <img [src]="member.avatar" [alt]="member.name" />
          <span>{{ member.name }}</span>
        </button>
      </div>
    </div>
    <div class="thread__composer-picker" *ngIf="isComposerEmojiPickerOpen">
      <button type="button" *ngFor="let emoji of emojiChoices" (click)="addComposerEmoji(emoji)">
        {{ emoji }}
      </button>
    </div>
    <div class="thread__composer-actions">
      <div class="thread__composer-start">
        <button
          type="button"
          class="thread__composer-button"
          aria-label="Emoji einfügen"
          (click)="toggleComposerEmojiPicker()">
          <mat-icon>sentiment_satisfied</mat-icon>
        </button>
        <button
          type="button"
          class="thread__composer-button"
          aria-label="Benutzer und Mentions"
          (click)="insertComposerMention()">
          <mat-icon>alternate_email</mat-icon>
        </button>
      </div>
      <button type="submit" class="thread__composer-send" [disabled]="replyForm.invalid">
        <mat-icon>send</mat-icon>
      </button>
    </div>
  </form>
</section>

<ng-template #idleThread>
  <section class="thread thread--empty">
    <div class="thread__empty-card">
      <h3>Wähle eine Nachricht aus</h3>
      <p>Fahre mit der Maus über eine Nachricht und klicke auf „Antworten“, um den Thread zu öffnen.</p>
    </div>
  </section>
</ng-template>
