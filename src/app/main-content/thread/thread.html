<section class="thread lg:rounded-3xl xl:ml-4" *ngIf="thread$ | async as thread; else idleThread">
  <header class="thread__header">
    <div>
      <p class="thread__eyebrow">Thread</p>
      <h2 class="thread__title"># {{ thread.channelTitle }}</h2>
    </div>
    <div class="thread__header-actions">
      <button type="button" class="thread__close hidden lg:flex" aria-label="Thread schließen" (click)="closeThread()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </header>
  <app-message-list class="message-list" #threadScrollArea>
    <ng-container
      *ngTemplateOutlet="threadMessage; context: { $implicit: thread.root, isRoot: true }"></ng-container>

    <div class="message-divider">
      <span>{{ thread.replies.length }} {{ thread.replies.length === 1 ? 'Antwort' : 'Antworten' }}</span>
    </div>

    <div class="thread__replies">
      <ng-container *ngFor="let reply of thread.replies">
        <ng-container *ngTemplateOutlet="threadMessage; context: { $implicit: reply, isRoot: false }"></ng-container>
      </ng-container>
    </div>
  </app-message-list>

  <app-message-composer
    [(text)]="draftReply"
    [placeholderPrefix]="'Antworten...'"
    [ariaLabel]="'Antwort zum Thread schreiben'"
    [isEmojiPickerOpen]="isComposerEmojiPickerOpen"
    [showMentions]="isMentionListVisible"
    [mentionType]="mentionType"
    [userSuggestions]="userMentionSuggestions"
    [channelSuggestions]="channelMentionSuggestions"
    [showMemberMentionTrigger]="true"
    [showChannelMentionTrigger]="true"
    [avatarUrlResolver]="avatarUrlResolver"
    [disableSend]="!draftReply.trim()"
    (composerInput)="onReplyInput($event)"
    (composerKeydown)="onReplyKeydown($event)"
    (submitMessage)="sendReply()"
    (toggleEmojiPicker)="toggleComposerEmojiPicker()"
    (emojiSelected)="addComposerEmoji($event)"
    (mentionTrigger)="insertComposerMention()"
    (channelMentionTrigger)="insertComposerChannel()"
    (userMentionSelected)="insertMention($event)"
    (channelMentionSelected)="insertChannel($event)"></app-message-composer>

  <ng-template #threadMessage let-message let-isRoot="isRoot">
    <app-message-item [message]="message" [avatarUrl]="getAvatarUrl(message.profilePictureKey)">
      <app-message-actions
        [message]="message"
        [currentUserId]="currentUser?.uid ?? null"
        [includePicker]="true"
        [includeEdit]="true"
        [isOwn]="message.isOwn"
        [isVisible]="openEmojiPickerFor === message.id"
        [isEmojiPickerOpen]="openEmojiPickerFor === message.id"
        (actionSelected)="handleThreadAction(message, $event, isRoot)"
        (emojiSelected)="isRoot ? reactToRootMessage($event) : reactToReply(message.id, $event)"></app-message-actions>

      <app-message-body
        [message]="message"
        [segments]="buildMessageSegments(message.text)"
        [isEditing]="editingMessageId === message.id"
        [(editText)]="editMessageText"
        [isSaving]="isSavingEdit"
        (saveEdit)="isRoot ? saveEditing(message, true) : saveEditing(message)"
        (cancelEdit)="cancelEditing()"
        (memberSelected)="openMemberProfile($event)">
        <app-message-reactions
          *ngIf="message.reactions"
          message-extra
          [reactions]="message.reactions"
          [currentUserId]="currentUser?.uid"
          (react)="isRoot ? reactToRootMessage($event) : reactToReply(message.id, $event)"
          (showTooltip)="showReactionTooltip($event.event, $event.emoji, $event.userIds)"
          (hideTooltip)="hideReactionTooltip()"></app-message-reactions>
      </app-message-body>
    </app-message-item>
  </ng-template>
</section>

<ng-template #idleThread>
  <section class="thread thread--empty">
    <div class="thread__empty-card">
      <h3>Wähle eine Nachricht aus</h3>
      <p>Fahre mit der Maus über eine Nachricht und klicke auf „Antworten“, um den Thread zu öffnen.</p>
    </div>
  </section>
</ng-template>
