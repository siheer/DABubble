<!-- Step 1: Channel Details -->
<section *ngIf="step === 1" class="create-channel-modal-overlay" (click)="cancel()">
  <form
    (ngSubmit)="onSubmitStep1(channelForm)"
    #channelForm="ngForm"
    class="create-channel-modal"
    (click)="$event.stopPropagation()">
    <header class="create-channel-modal__header">
      <div class="create-channel-modal__titles">
        <h2>Channel erstellen</h2>
        <p>
          Channels dienen deinem Team zur Kommunikation. Am besten sollten sie themenbezogen sein #marketing zum
          Beispiel.
        </p>
      </div>
      <button type="button" class="create-channel-modal__close" (click)="cancel()" aria-label="Schließen">
        <mat-icon>close</mat-icon>
      </button>
    </header>

    <label class="create-channel-modal__field">
      <div class="create-channel-modal__label-row">
        <span class="create-channel-modal__label">Channel-Name</span>
      </div>
      <input
        id="channel-name"
        type="text"
        name="title"
        [(ngModel)]="title"
        required
        maxlength="50"
        placeholder="# z.B. Kooperationsprojekte"
        autocomplete="off" />
    </label>

    <label class="create-channel-modal__field">
      <div class="create-channel-modal__label-row">
        <span class="create-channel-modal__label">Beschreibung</span>
        <span class="create-channel-modal__optional">(optional)</span>
      </div>
      <textarea
        id="channel-description"
        name="description"
        [(ngModel)]="description"
        maxlength="200"
        rows="3"
        placeholder="Dein Text hier"></textarea>
    </label>

    <div *ngIf="isAdmin()" class="create-channel-modal__field">
      <div class="create-channel-modal__label-row">
        <span class="create-channel-modal__label">Channel-Zugriff</span>
        <span class="create-channel-modal__optional">nur Admins</span>
      </div>
      <label class="create-channel-modal__checkbox">
        <input id="channel-public" type="checkbox" name="isPublic" [(ngModel)]="isPublic" />
        <span>Für alle User zugänglich</span>
      </label>
    </div>

    <p *ngIf="errorMessage" class="create-channel-modal__error" role="alert">{{ errorMessage }}</p>

    <div class="create-channel-modal__actions">
      <button type="submit" class="create-channel-modal__primary" [disabled]="channelForm.invalid">Erstellen</button>
    </div>
  </form>
</section>

<!-- Step 2: Member Selection -->
<section *ngIf="step === 2" class="member-selection-overlay" (click)="cancel()">
  <div class="member-selection-modal" (click)="$event.stopPropagation()">
    <div class="flex w-full justify-center sm:hidden">
      <span class="h-1.5 w-16 cursor-pointer rounded-full bg-gray-300" (click)="goBackToStep1()"></span>
    </div>
    <header class="member-selection-modal__header">
      <button type="button" class="member-selection-modal__back" (click)="goBackToStep1()" aria-label="Zurück">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2>Leute hinzufügen</h2>
      <button type="button" class="member-selection-modal__close" (click)="cancel()" aria-label="Schließen">
        <mat-icon>close</mat-icon>
      </button>
    </header>

    <div class="member-selection-modal__options">
      <label class="member-selection-modal__option">
        <input type="checkbox" name="addAllMembers" [(ngModel)]="addAllMembers" (change)="onToggleAllMembers()" />
        <span>
          Alle Mitglieder von
          <span class="member-selection-modal__channel">Allgemein</span>
          hinzufügen
        </span>
      </label>

      <label class="member-selection-modal__option">
        <input
          type="checkbox"
          name="addSpecificMembers"
          [(ngModel)]="addSpecificMembers"
          (change)="onToggleSpecificMembers()" />
        <span>Bestimmte Leute hinzufügen</span>
      </label>
    </div>

    <div class="member-selection-modal__expand" *ngIf="addSpecificMembers">
      <div class="member-selection__search">
        <input
          type="text"
          name="memberSearch"
          placeholder="Name eingeben"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
          (focus)="onSearchFocus()"
          autocomplete="off" />
      </div>

      <div *ngIf="selectedMembers.length" class="member-selection__chips">
        <div *ngFor="let member of selectedMembers" class="member-chip">
          <img [src]="member.avatar" [alt]="member.name" />
          <span>{{ member.name }}</span>
          <button type="button" (click)="removeSelectedMember(member.id)" aria-label="{{ member.name }} entfernen">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <div class="member-selection__dropdown" *ngIf="showSuggestions">
        <div *ngIf="filteredMembers.length === 0" class="member-selection__empty">
          Keine weiteren Mitglieder gefunden.
        </div>

        <button
          type="button"
          *ngFor="let member of filteredMembers"
          class="member-option"
          (click)="selectMember(member)">
          <img [src]="member.avatar" [alt]="member.name" />
          <div class="member-option__meta">
            <span class="member-option__name truncate">{{ member.name }}</span>
            <span *ngIf="member.subtitle" class="member-option__subtitle">{{ member.subtitle }}</span>
          </div>
          <span
            *ngIf="member.status === 'online'"
            class="member-option__status flex-shrink-0"
            aria-label="Online"></span>
        </button>

        <div class="member-selection__dropdown-actions">
          <button type="button" class="btn-text" (click)="confirmSuggestions()">Auswahl bestätigen</button>
        </div>
      </div>
    </div>

    <p *ngIf="errorMessage" class="member-selection__error" role="alert">{{ errorMessage }}</p>

    <div class="member-selection-modal__actions">
      <button
        type="button"
        class="btn-primary"
        (click)="createChannel()"
        [disabled]="!canCreateChannel() || isSubmitting">
        <ng-container *ngIf="!isSubmitting; else creating">Erstellen</ng-container>
        <ng-template #creating>Wird erstellt...</ng-template>
      </button>
    </div>
  </div>
</section>
