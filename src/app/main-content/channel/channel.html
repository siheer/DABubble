<mat-sidenav-container class="channel-layout" [hasBackdrop]="false">
  <mat-sidenav-content class="channel-layout__content">
    <section class="channel lg:rounded-3xl">
      <header class="channel__header">
        <div class="channel__titles">
          <div class="channel__title-row">
            <button
              type="button"
              class="channel__description-trigger"
              aria-label="Channel-Beschreibung öffnen"
              (click)="openChannelDescription($event)">
              <h1># {{ (channelTitle$ | async) ?? channelDefaults.name }}</h1>
              <img src="imgs/channel description/keyboard_arrow_down.svg" alt="Channel-Beschreibung öffnen" />
            </button>
          </div>
        </div>
        <div class="channel__actions">
          <ng-container *ngIf="members$ | async as members">
            <button
              type="button"
              class="channel__member-preview"
              aria-label="Mitgliederübersicht"
              (click)="openChannelMembers($event)">
              <div class="channel__avatars" aria-hidden="true">
                <ng-container *ngFor="let member of members | slice: 0 : 3; let i = index">
                  <img
                    [src]="getAvatarUrl(member.profilePictureKey)"
                    [alt]="member.name"
                    [style.zIndex]="members.length - i" />
                </ng-container>
              </div>
              <span class="channel__member-count">{{ members.length }}</span>
            </button>
          </ng-container>

          <button
            type="button"
            class="channel__add-member"
            aria-label="Mitglied zum Channel hinzufügen"
            (click)="openAddToChannel($event)">
            <img src="imgs/channels/person_add.svg" alt="Mitglied hinzufügen" />
          </button>
        </div>
      </header>

      <section class="channel__panel">
        <app-message-list class="message-list" aria-live="polite" #channelMessages>
          <ng-container *ngIf="messagesByDay$ | async as messagesByDay">
            <ng-container *ngIf="messagesByDay.length; else noMessages">
              <ng-container *ngFor="let day of messagesByDay">
                <div class="message-divider">
                  <span>{{ day.label }}</span>
                </div>

                <app-message-item
                  *ngFor="let message of day.messages; trackBy: trackByMessageId"
                  [message]="message"
                  [idPrefix]="'message-'"
                  [avatarUrl]="getAvatarUrl(message.profilePictureKey)">
                  <app-message-actions
                    [message]="message"
                    [currentUserId]="currentUser?.uid ?? null"
                    [includeCheck]="true"
                    [includeThumb]="true"
                    [includePicker]="true"
                    [includeThread]="true"
                    [includeEdit]="true"
                    [isOwn]="message.isOwn"
                    [isVisible]="openEmojiPickerFor === message.id"
                    [isEmojiPickerOpen]="openEmojiPickerFor === message.id"
                    (actionSelected)="handleMessageAction(message, $event)"
                    (emojiSelected)="react(message, $event)"></app-message-actions>

                  <app-message-body
                    [message]="message"
                    [segments]="buildMessageSegments(message)"
                    [isEditing]="editingMessageId === message.id"
                    [(editText)]="editMessageText"
                    [isSaving]="isSavingEdit"
                    (saveEdit)="message.id && saveEditingMessage(message.id)"
                    (cancelEdit)="cancelEditingMessage()"
                    (memberSelected)="openMemberProfile($event)">
                    <app-message-reactions
                      *ngIf="message.reactions"
                      message-extra
                      [reactions]="message.reactions"
                      [currentUserId]="currentUser?.uid"
                      (react)="react(message, $event)"
                      (showTooltip)="showReactionTooltip($event.event, $event.emoji, $event.userIds)"
                      (hideTooltip)="hideReactionTooltip()"></app-message-reactions>

                    <button
                      *ngIf="message.replies"
                      message-extra
                      type="button"
                      class="channel__thread-summary"
                      (click)="openThread(message)">
                      <span class="channel__thread-count">
                        {{ message.replies }} Antwort{{ message.replies === 1 ? '' : 'en' }}
                      </span>
                      <span *ngIf="message.lastReplyTimeLabel" class="channel__thread-meta">
                        Letzte Antwort {{ message.lastReplyTimeLabel }}
                      </span>
                    </button>
                  </app-message-body>
                </app-message-item>
              </ng-container>
            </ng-container>
          </ng-container>
          <ng-template #noMessages>
            <p class="channel__empty">Noch keine Nachrichten vorhanden.</p>
          </ng-template>
        </app-message-list>

        <app-message-composer
          aria-label="Neue Nachricht verfassen"
          [(text)]="messageText"
          [placeholderPrefix]="'Nachricht an '"
          [placeholderHighlight]="'#' + ((channelTitle$ | async) ?? channelDefaults.name)"
          [ariaLabel]="'Neue Nachricht verfassen'"
          [disabled]="isSending"
          [disableSend]="!messageText.trim() || isSending"
          [isEmojiPickerOpen]="isComposerEmojiPickerOpen"
          [showMentions]="isMentionListVisible"
          [mentionType]="mentionType"
          [userSuggestions]="userMentionSuggestions"
          [channelSuggestions]="channelMentionSuggestions"
          [showMemberMentionTrigger]="true"
          [showChannelMentionTrigger]="true"
          [avatarUrlResolver]="avatarUrlResolver"
          (composerInput)="onMessageInput($event)"
          (composerKeydown)="onComposerKeydown($event)"
          (submitMessage)="sendMessage()"
          (toggleEmojiPicker)="toggleComposerEmojiPicker()"
          (emojiSelected)="addComposerEmoji($event)"
          (mentionTrigger)="insertComposerMention()"
          (channelMentionTrigger)="insertComposerChannel()"
          (userMentionSelected)="insertMention($event)"
          (channelMentionSelected)="insertChannel($event)"></app-message-composer>
      </section>
    </section>
  </mat-sidenav-content>

  <mat-sidenav
    #threadSidenav
    class="channel-layout__thread"
    position="end"
    [mode]="isTabletScreen() ? 'over' : 'side'"
    [opened]="hasThreadChild()"
    [disableClose]="!isTabletScreen()"
    (opened)="updateThreadPanelOpenState(true)"
    (closedStart)="updateThreadPanelOpenState(false)"
    (closed)="closeThread()">
    <router-outlet></router-outlet>
  </mat-sidenav>
</mat-sidenav-container>
