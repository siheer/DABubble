<section class="message-board lg:rounded-3xl" *ngIf="selectedRecipient$ | async as recipient; else chooseRecipient">
  <!-- Recipient header with avatar and quick context. -->
  <header class="message-board__header">
    <div
      class="message-board__identity"
      role="button"
      tabindex="0"
      (click)="openRecipientProfile(recipient)"
      (keydown.enter)="openRecipientProfile(recipient)"
      (keydown.space)="openRecipientProfile(recipient)">
      <img
        class="message-board__avatar"
        [src]="recipient.photoUrl || 'imgs/default-profile-picture.png'"
        [alt]="recipient.name" />
      <div>
        <div class="message-board__name-row">
          <h1>{{ recipient.name }}</h1>
          <span class="message-board__status-dot" aria-hidden="true"></span>
        </div>
        <p>{{ recipient.email || 'Direktnachricht' }}</p>
      </div>
    </div>
  </header>

  <ng-container *ngIf="messages$ | async as messages">
    <!-- Scrollable conversation stream. -->
    <section class="message-board__stream" aria-live="polite" *ngIf="messages.length" #messageStream>
      <ng-container *ngFor="let message of messages; let i = index">
        <div class="message-board__divider" *ngIf="shouldShowDateDivider(messages, i)">
          <span>{{ formatDateLabel(message.timestamp) }}</span>
        </div>
        <article class="message-board__bubble" [class.message-board__bubble--own]="message.isOwn">
          <div
            class="message-board__bubble-actions"
            [class.message-board__bubble-actions--visible]="openEmojiPickerFor === message.id"
            [class.message-board__bubble-actions--own]="message.isOwn">
            <button
              type="button"
              class="message-board__bubble-action"
              aria-label="Daumen hoch geben"
              [class.message-board__bubble-action--active]="message.reactions?.['üëç']?.includes(currentUser?.uid ?? '')"
              (click)="reactToDmMessage(message.id, 'üëç')">
              üëç
            </button>
            <button
              type="button"
              class="message-board__bubble-action"
              aria-label="Gr√ºnen Haken setzen"
              [class.message-board__bubble-action--active]="message.reactions?.['‚úÖ']?.includes(currentUser?.uid ?? '')"
              (click)="reactToDmMessage(message.id, '‚úÖ')">
              ‚úÖ
            </button>
            <button
              type="button"
              class="message-board__bubble-action"
              aria-label="Emoji-Auswahl √∂ffnen"
              (click)="toggleEmojiPicker(message.id)">
              <mat-icon>add_reaction</mat-icon>
            </button>
            <button
              *ngIf="message.isOwn"
              type="button"
              class="message-board__bubble-action"
              aria-label="Nachricht bearbeiten"
              (click)="startEditing(message)">
              <mat-icon>more_vert</mat-icon>
            </button>

            <div
              class="message-board__emoji-picker"
              [class.message-board__emoji-picker--own]="message.isOwn"
              *ngIf="openEmojiPickerFor === message.id">
              <button
                type="button"
                *ngFor="let emoji of emojiChoices"
                (click)="reactToDmMessage(message.id, emoji)"
                aria-label="Emoji ausw√§hlen">
                {{ emoji }}
              </button>
            </div>
          </div>

          <div class="message-board__bubble-main">
            <img class="message-board__bubble-avatar" [src]="message.avatar" [alt]="message.author" />
            <div class="message-board__bubble-body">
              <div class="message-board__bubble-header">
                <strong class="message-board__bubble-author">{{ message.author }}</strong>
                <time class="message-board__bubble-time">{{ formatTimestamp(message.timestamp) }}</time>
              </div>
              <div class="message-board__bubble-content">
                <ng-container *ngIf="editingMessageId !== message.id; else editMessage">
                  <p class="message-board__bubble-text">{{ message.content }}</p>
                </ng-container>
                <ng-template #editMessage>
                  <div class="message-board__bubble-edit">
                    <textarea
                      name="edit-message"
                      [(ngModel)]="editMessageText"
                      rows="3"
                      aria-label="Nachricht bearbeiten"></textarea>
                    <div class="message-board__bubble-edit-actions">
                      <button type="button" class="message-board__bubble-edit-cancel" (click)="cancelEditing()">
                        Abbrechen
                      </button>
                      <button
                        type="button"
                        class="message-board__bubble-edit-save"
                        [disabled]="!editMessageText.trim() || isSavingEdit"
                        (click)="message.id && saveEditing(message.id)">
                        Speichern
                      </button>
                    </div>
                  </div>
                </ng-template>
              </div>
              <ng-container *ngIf="message.id as messageId">
                <app-message-reactions
                  *ngIf="message.reactions"
                  [reactions]="message.reactions"
                  [currentUserId]="currentUser?.uid"
                  (react)="reactToDmMessage(message.id, $event)"
                  (showTooltip)="showReactionTooltip($event.event, $event.emoji, $event.userIds)"
                  (hideTooltip)="hideReactionTooltip()">
                </app-message-reactions>
              </ng-container>
            </div>
          </div>
        </article>
      </ng-container>
    </section>

    <div class="message-board__intro" *ngIf="!messages.length">
      <img
        class="message-board__intro-avatar"
        [src]="recipient.photoUrl || 'imgs/default-profile-picture.png'"
        [alt]="recipient.name" />
      <div class="message-board__intro-text">
        <p class="message-board__intro-name">{{ recipient.name }}</p>
        <p>Diese Unterhaltung findet nur zwischen {{ recipient.name }} und dir statt.</p>
      </div>
    </div>
  </ng-container>

  <!-- Message composer with icon-only helper buttons. -->
  <form class="message-board__composer" (ngSubmit)="sendMessage()" #messageForm="ngForm">
    <textarea
      #composerTextarea
      name="message"
      required
      [(ngModel)]="draftMessage"
      placeholder="Nachricht an {{ recipient.name }}"
      [disabled]="isSending"
      aria-label="Neue Nachricht verfassen"
      (keydown.enter)="onComposerKeydown($event)"></textarea>
    <div class="message-board__composer-picker" *ngIf="isComposerEmojiPickerOpen">
      <button type="button" *ngFor="let emoji of emojiChoices" (click)="addComposerEmoji(emoji)">
        {{ emoji }}
      </button>
    </div>

    <div class="message-board__composer-actions">
      <div class="message-board__composer-start">
        <button type="button" aria-label="Emoji einf√ºgen" (click)="toggleComposerEmojiPicker()">
          <mat-icon>sentiment_satisfied</mat-icon>
        </button>
      </div>
      <div class="message-board__composer-end">
        <button type="submit" aria-label="Nachricht senden" [disabled]="!draftMessage.trim() || isSending">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  </form>
</section>

<ng-template #chooseRecipient>
  <section class="message-board message-board__empty">
    <header class="message-board__header">
      <div class="message-board__identity">
        <div class="message-board__avatar placeholder"></div>
        <div>
          <h1>Direktnachricht starten</h1>
          <p>W√§hle links eine Person aus, um den Chat zu √∂ffnen.</p>
        </div>
      </div>
    </header>
    <p class="message-board__subtitle">
      Du hast noch keine Direktnachricht ausgew√§hlt. Tippe im Workspace auf einen Kontakt, um hier die Unterhaltung zu
      sehen.
    </p>
  </section>
</ng-template>
